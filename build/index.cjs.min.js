"use strict";const t={priority:1},e={exact:!1},s={debug:!1,suppress:!0,async:!1},i=function(t){var e=function(t){for(var e,s="0123456789ABCDEF",i="",n=0;n<t.length;n++)e=t.charCodeAt(n),i+=s.charAt(e>>>4&15)+s.charAt(15&e);return i}(function(t){for(var e="",s=0;s<32*t.length;s+=8)e+=String.fromCharCode(t[s>>5]>>>s%32&255);return e}(function(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;for(var s=1732584193,i=-271733879,n=-1732584194,c=271733878,u=0;u<t.length;u+=16){var d=s,f=i,g=n,p=c;i=l(i=l(i=l(i=l(i=h(i=h(i=h(i=h(i=o(i=o(i=o(i=o(i=r(i=r(i=r(i=r(i,n=r(n,c=r(c,s=r(s,i,n,c,t[u+0],7,-680876936),i,n,t[u+1],12,-389564586),s,i,t[u+2],17,606105819),c,s,t[u+3],22,-1044525330),n=r(n,c=r(c,s=r(s,i,n,c,t[u+4],7,-176418897),i,n,t[u+5],12,1200080426),s,i,t[u+6],17,-1473231341),c,s,t[u+7],22,-45705983),n=r(n,c=r(c,s=r(s,i,n,c,t[u+8],7,1770035416),i,n,t[u+9],12,-1958414417),s,i,t[u+10],17,-42063),c,s,t[u+11],22,-1990404162),n=r(n,c=r(c,s=r(s,i,n,c,t[u+12],7,1804603682),i,n,t[u+13],12,-40341101),s,i,t[u+14],17,-1502002290),c,s,t[u+15],22,1236535329),n=o(n,c=o(c,s=o(s,i,n,c,t[u+1],5,-165796510),i,n,t[u+6],9,-1069501632),s,i,t[u+11],14,643717713),c,s,t[u+0],20,-373897302),n=o(n,c=o(c,s=o(s,i,n,c,t[u+5],5,-701558691),i,n,t[u+10],9,38016083),s,i,t[u+15],14,-660478335),c,s,t[u+4],20,-405537848),n=o(n,c=o(c,s=o(s,i,n,c,t[u+9],5,568446438),i,n,t[u+14],9,-1019803690),s,i,t[u+3],14,-187363961),c,s,t[u+8],20,1163531501),n=o(n,c=o(c,s=o(s,i,n,c,t[u+13],5,-1444681467),i,n,t[u+2],9,-51403784),s,i,t[u+7],14,1735328473),c,s,t[u+12],20,-1926607734),n=h(n,c=h(c,s=h(s,i,n,c,t[u+5],4,-378558),i,n,t[u+8],11,-2022574463),s,i,t[u+11],16,1839030562),c,s,t[u+14],23,-35309556),n=h(n,c=h(c,s=h(s,i,n,c,t[u+1],4,-1530992060),i,n,t[u+4],11,1272893353),s,i,t[u+7],16,-155497632),c,s,t[u+10],23,-1094730640),n=h(n,c=h(c,s=h(s,i,n,c,t[u+13],4,681279174),i,n,t[u+0],11,-358537222),s,i,t[u+3],16,-722521979),c,s,t[u+6],23,76029189),n=h(n,c=h(c,s=h(s,i,n,c,t[u+9],4,-640364487),i,n,t[u+12],11,-421815835),s,i,t[u+15],16,530742520),c,s,t[u+2],23,-995338651),n=l(n,c=l(c,s=l(s,i,n,c,t[u+0],6,-198630844),i,n,t[u+7],10,1126891415),s,i,t[u+14],15,-1416354905),c,s,t[u+5],21,-57434055),n=l(n,c=l(c,s=l(s,i,n,c,t[u+12],6,1700485571),i,n,t[u+3],10,-1894986606),s,i,t[u+10],15,-1051523),c,s,t[u+1],21,-2054922799),n=l(n,c=l(c,s=l(s,i,n,c,t[u+8],6,1873313359),i,n,t[u+15],10,-30611744),s,i,t[u+6],15,-1560198380),c,s,t[u+13],21,1309151649),n=l(n,c=l(c,s=l(s,i,n,c,t[u+4],6,-145523070),i,n,t[u+11],10,-1120210379),s,i,t[u+2],15,718787259),c,s,t[u+9],21,-343485551),s=a(s,d),i=a(i,f),n=a(n,g),c=a(c,p)}return Array(s,i,n,c)}(function(t){for(var e=Array(t.length>>2),s=0;s<e.length;s++)e[s]=0;for(s=0;s<8*t.length;s+=8)e[s>>5]|=(255&t.charCodeAt(s/8))<<s%32;return e}(t),8*t.length)));return e.toLowerCase()};function n(t,e,s,i,n,r){return a(function(t,e){return t<<e|t>>>32-e}(a(a(e,t),a(i,r)),n),s)}function r(t,e,s,i,r,o,h){return n(e&s|~e&i,t,e,r,o,h)}function o(t,e,s,i,r,o,h){return n(e&i|s&~i,t,e,r,o,h)}function h(t,e,s,i,r,o,h){return n(e^s^i,t,e,r,o,h)}function l(t,e,s,i,r,o,h){return n(s^(e|~i),t,e,r,o,h)}function a(t,e){var s=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(s>>16)<<16|65535&s}const c=(t,e)=>{for(let s in e)t.hasOwnProperty(s)||(t[s]=e[s]);return t};class u{constructor(t,e=!1){this.original=t;const s=t.split(".");this.#t(s,e),s.length&&"*"===s[s.length-1]?(this.deep=!0,s.pop()):this.deep=!1,""!==this.original&&s.unshift(""),this.parts=s}#t(t,e){let s=[],i=null;if(t.forEach(((n,r)=>{"*"===n&&(e?s.push("Asterisk is not allowed when emitting event"):(null!==i&&s.push("Multiple asterisks found, only one expected"),i=r,i<t.length-1&&s.push("Asterisk allowed only at the end of the path")))})),s.length)throw new Error(`Path ${this.original}, found violations: `+s.toString())}getNodeHash(t=null){null===t&&(t=this.parts.length-1);const e=this.parts.slice(0,t+1);return i(e.join(".")+String(this.parts[t])+t)}*iterateHashes(t=!1){for(let e=t?this.parts.length-1:1;t?e>=0:e<=this.parts.length;t?e--:e++){const t=this.parts.slice(0,e);if(!t.length)return;yield i(t.join("."))}}getTailHash=()=>i(this.parts.join("."))}class d{constructor(e,s,n,r={}){this.config=c(r,t),this.handler=e,this.path=new u(s),this.bus=n,this.handlerHash=i(e.toString()),this.node=null}async call(t=null){await this.handler(t)}off(){this.bus.offListener(this)}setNode(t){this.node=t}getNode=()=>this.node;getPath=()=>this.path;isDeep=()=>this.path.deep;getPriority=()=>this.config.priority??0}class f{constructor(t,e){this.name=t,this.level=e,this.parent=null,this.children=[],this.listeners=[]}setParent(t){this.parent||(this.parent=t,this.parent.setChild(this))}setChild(t){this.children.push(t)}addListener(t){this.listeners.push(t),t.setNode(this)}off(t){const e=this.listeners.findIndex((e=>e===t));-1!==e&&this.listeners.splice(e,1)}getDirectListeners(){return Array.from(this.listeners)}getDeepListeners=()=>this.listeners.filter((t=>t.isDeep()));getParent=()=>this.parent;getChilds=()=>Array.from(this.children)}class g{constructor(t,e={}){this.config=c(e,s),this.id=t,this.nodes={}}addListener(t){return this.#e(t.getPath()).addListener(t),t}offListener(t){let e=t.getNode();if(e)for(e.off(t);e;){let t=e.getParent();e.getDirectListeners().length||e.getChilds().length||-1!==index&&this.#s(e),e=t}}#s(t){let e=this.nodes.findIndex((e=>e===t));-1!==e&&this.nodes.splice(e,1)}call(t){const e=[];let s=this.#i(t.path);if(t.isExact()&&!s)return void(this.isDebug()&&console.info(`${t.path.original}: no listeners on exact path`));s&&e.push(...s.getDirectListeners());let i=this.#n(t.path,!0);for(let t of i)t!==s&&e.push(...t.getDeepListeners());return e.sort(((t,e)=>t.getPriority()-e.getPriority())),this.isAsync()?Promise.all(e.map((e=>e.call(t.payload).catch((t=>{if(!this.isSuppressing())throw t;console.warn("Suppressed exception from listener",t)}))))):e.reduce(((e,s)=>e.then((()=>s.call(t.payload).catch((t=>{if(!this.isSuppressing())throw t;console.warn("Suppressed exception from listener",t)}))))),Promise.resolve())}#e=t=>{const e=t.iterateHashes();let s=0,i=null;for(let t of e){let e=this.#r(t)||(this.nodes[t]=new f(t,s++));i&&e.setParent(i),i=e}return i};#i=t=>this.#r(t.getTailHash())??null;#n=function*(t,e=!1){const s=t.iterateHashes(e);for(let t of s){let e=this.#r(t);e&&(yield e)}};#r=t=>this.nodes[t];isSuppressing=()=>this.config.suppress;isDebug=()=>this.config.debug;isAsync=()=>this.config.async}class p{constructor(t,s=null,i={}){this.config=c(i,e),this.path=new u(t,!0),this.payload=s}isExact=()=>this.config.exact}const y={};exports.bus=(t="default",e={})=>{y[t]?Object.keys(e).length&&console.warn(`Bus ${t} was already defined, but there is another call with config. This config was not applied`):y[t]=new g(t,e);const s=y[t];return{on:(t,e,i={})=>{const n=new d(e,t,s,i);return s.addListener(n)},emit:(t,e=null,i={})=>{const n=new p(t,e,i);return s.call(n)}}};
